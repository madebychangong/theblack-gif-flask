<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>더블랙샵 - WebP 애니메이션 생성기 (워터마크 자동)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Noto Sans KR', Arial, sans-serif;
      background-color: #121212;
      color: #fff;
      padding: 40px 20px;
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #1e1e1e;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
    h2 {
      color: #ffd700;
      text-align: center;
      margin-bottom: 30px;
    }
    .section {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .section h3 {
      color: #00ffd5;
      margin-top: 0;
    }
    .info-box {
      background: rgba(0, 255, 213, 0.1);
      border: 2px solid #00ffd5;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    .info-box strong {
      color: #00ffd5;
    }
    textarea {
      width: 100%;
      height: 200px;
      padding: 16px;
      font-size: 16px;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 6px;
      resize: vertical;
      line-height: 1.6;
      font-family: 'Noto Sans KR', monospace;
    }
    button {
      margin-top: 15px;
      background-color: #ffd700;
      color: #000;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s;
      width: 100%;
    }
    button:hover:not(:disabled) {
      background-color: #ffed4e;
      transform: scale(1.02);
    }
    button:disabled {
      background-color: #666;
      cursor: not-allowed;
      transform: scale(1);
    }
    #message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      font-size: 15px;
      display: none;
    }
    #message.show { display: block; }
    #message.info {
      background: #1e3a5f;
      color: #5dade2;
    }
    #message.success {
      background: #1e4d2b;
      color: #52c41a;
    }
    #message.error {
      background: #4d1e1e;
      color: #ff6b6b;
    }
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #333;
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
      display: none;
    }
    .progress-bar.show { display: block; }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ffd5, #ffd700);
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-weight: bold;
      font-size: 14px;
    }
    .result-box {
      background: #232323;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #00ffd5;
      margin-top: 30px;
      display: none;
    }
    .result-box.show { display: block; }
    .result-box h4 {
      color: #ffd700;
      margin-top: 0;
    }
    .preview-container {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }
    .preview-container img {
      max-width: 100%;
      border-radius: 8px;
      margin: 10px 0;
    }
    .copy-btn {
      background: #00ffd5;
      color: #000;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
      width: auto;
    }
    .copy-btn:hover {
      background: #00e6c3;
    }
    #debugLog {
      background: #0a0a0a;
      color: #0f0;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
      display: none;
    }
    #debugLog.show { display: block; }
    #hiddenRender {
      position: fixed;
      left: -10000px;
      top: 0;
    }
    
    /* ============================================
       💧 워터마크 시스템 (자동 적용)
       ⚠️ 이 부분은 수정하지 마세요!
       ============================================ */
    
    .watermark-container {
      position: relative;
      width: 720px;
    }
    
    /* 4개 모서리 배지 */
    .corner-badge {
      position: absolute;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 900;
      border-radius: 50%;
      border: 3px solid;
      text-align: center;
      line-height: 1.2;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    .corner-badge.top-left { top: 15px; left: 15px; }
    .corner-badge.top-right { top: 15px; right: 15px; }
    .corner-badge.bottom-left { bottom: 15px; left: 15px; }
    .corner-badge.bottom-right { bottom: 15px; right: 15px; }
    
    /* 가격표 내부 워터마크 (대각선 3개) */
    .content-watermark {
      position: absolute;
      font-size: 18px;
      font-weight: 900;
      opacity: 0.2;
      pointer-events: none;
      letter-spacing: 2px;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
      z-index: 500;
    }
    
    .wm-diagonal-1 { top: 30%; left: 10%; transform: rotate(-15deg); }
    .wm-diagonal-2 { top: 50%; right: 15%; transform: rotate(15deg); }
    .wm-diagonal-3 { top: 70%; left: 15%; transform: rotate(-12deg); }
    .wm-diagonal-4 { top: 55%; right: 8%; transform: rotate(10deg); }
.wm-diagonal-5 { top: 65%; left: 10%; transform: rotate(-12deg); }
.wm-diagonal-6 { top: 75%; right: 12%; transform: rotate(14deg); }
.wm-diagonal-7 { top: 82%; left: 8%; transform: rotate(-8deg); }
.wm-diagonal-8 { top: 90%; right: 10%; transform: rotate(12deg); }
    
    /* 하단 중앙 스티커 */
    .center-sticker {
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      border: 3px solid;
      border-radius: 12px;
      padding: 15px 25px;
      text-align: center;
      box-shadow: 0 0 30px rgba(0,0,0,0.7);
      z-index: 1000;
    }
    
    .sticker-title {
      font-size: 20px;
      font-weight: 900;
      margin: 0 0 8px 0;
      letter-spacing: 2px;
    }
    
    .sticker-check {
      font-size: 24px;
      margin: 5px 0;
    }
    
    .sticker-desc {
      font-size: 13px;
      font-weight: 700;
      margin: 5px 0 0 0;
      line-height: 1.4;
    }
    
    /* 프레임별 색상 (자동 적용) */
    .frame-1 .corner-badge { background: #ffd700; border-color: #ffd700; color: #000; }
    .frame-1 .content-watermark { color: #ffd700; }
    .frame-1 .center-sticker { border-color: #ffd700; }
    .frame-1 .sticker-title, .frame-1 .sticker-check, .frame-1 .sticker-desc { color: #ffd700; }
    .frame-1 .auth-warning { border-color: #ffd700; color: #ffd700; }
    
    .frame-2 .corner-badge { background: #00ffd5; border-color: #00ffd5; color: #000; }
    .frame-2 .content-watermark { color: #00ffd5; }
    .frame-2 .center-sticker { border-color: #00ffd5; }
    .frame-2 .sticker-title, .frame-2 .sticker-check, .frame-2 .sticker-desc { color: #00ffd5; }
    .frame-2 .auth-warning { border-color: #00ffd5; color: #00ffd5; }
    
    .frame-3 .corner-badge { background: #a855f7; border-color: #a855f7; color: #000; }
    .frame-3 .content-watermark { color: #a855f7; }
    .frame-3 .center-sticker { border-color: #a855f7; }
    .frame-3 .sticker-title, .frame-3 .sticker-check, .frame-3 .sticker-desc { color: #a855f7; }
    .frame-3 .auth-warning { border-color: #a855f7; color: #a855f7; }
    
    .frame-4 .corner-badge { background: #ff6b6b; border-color: #ff6b6b; color: #000; }
    .frame-4 .content-watermark { color: #ff6b6b; }
    .frame-4 .center-sticker { border-color: #ff6b6b; }
    .frame-4 .sticker-title, .frame-4 .sticker-check, .frame-4 .sticker-desc { color: #ff6b6b; }
    .frame-4 .auth-warning { border-color: #ff6b6b; color: #ff6b6b; }
    
    /* ============================================
       🎨 디자인 부분 (자유롭게 수정하세요!)
       ============================================ */
    
    .price-image {
      width: 720px;
      background: linear-gradient(135deg, 
        #1a1a2e 0%, 
        #16213e 25%, 
        #0f3460 50%, 
        #533483 75%, 
        #1a1a2e 100%);
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans KR', Arial, sans-serif;
    }
    
    .auth-warning {
      background: rgba(255, 215, 0, 0.15);
      border: 2px solid;
      border-radius: 12px;
      padding: 12px 15px;
      margin: 15px 40px 20px 40px;
      font-size: 15px;
      font-weight: 700;
      text-align: center;
    }
    
    .header-static {
      width: 100%;
      background: rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(20px);
      padding: 40px 42px 30px 42px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(255, 255, 255, 0.05);
    }
    
    .shop-logo {
      font-size: 46px;
      font-weight: 700;
      color: #ffe85c;
      margin: 0 0 12px 0;
      letter-spacing: 2.5px;
      text-shadow: 
        0 0 10px rgba(255, 232, 92, 0.5),
        0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .shop-tagline {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 400;
      letter-spacing: 0.8px;
      margin: 0 0 20px 0;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .shop-features {
      list-style: none;
      padding: 0;
      margin: 20px 0 0 0;
      font-size: 18px;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .shop-features li {
      margin: 8px 0;
      line-height: 1.65;
      letter-spacing: 0.3px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .cta-btn {
      margin: 20px auto;
      background: linear-gradient(135deg, #1affeb 0%, #0ee5d0 100%);
      color: #0a0a0a;
      font-weight: 900;
      font-size: 23px;
      padding: 14px 40px;
      border-radius: 22px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: inline-block;
      box-shadow: 
        0 4px 16px rgba(26, 255, 235, 0.3),
        0 2px 4px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      letter-spacing: 0.5px;
    }
    
    .divider {
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      margin: 20px 40px;
    }
    
    .price-content {
      width: 100%;
      padding: 30px 42px 100px 42px;
    }
    
    .price-title {
      font-size: 32px;
      color: #3dffb8;
      font-weight: 900;
      margin: 0 0 20px 0;
      text-align: center;
      letter-spacing: 1.2px;
      text-shadow: 
        0 0 10px rgba(61, 255, 184, 0.4),
        0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .price-text {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.85);
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      white-space: pre-wrap;
      line-height: 1.75;
      letter-spacing: 0.6px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .chat-link {
      margin: 10px 0;
      padding: 10px 0;
      font-weight: 800;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>🦇 THE BLACK SHOP - WebP 애니메이션 생성기</h2>
    
    <div class="info-box">
      <strong>💧 워터마크 자동 적용 버전</strong><br>
      • 총 8개 마크: 모서리 4개 + 가격표 내부 3개 + 하단 스티커 1개<br>
      • 4가지 색상 자동 순환: 금색 → 청록 → 보라 → 빨강<br>
      • 나 잘했죠?? ㅋㅋㅋㅋㅋㅋ
    </div>
    
    <div class="section">
      <h3>📝 가격표 텍스트 입력</h3>
      <textarea id="priceText" placeholder="여기에 가격표 텍스트를 입력하세요...

예시:
⚔️ 시즌10 버스 서비스
-------------------
🏆 랭크 버스
- 골드 → 플래티넘: 50,000원
-------------------
🎯 던전 대리
- 나이트메어: 30,000원/시간
"></textarea>
      <button id="generateBtn" onclick="startGeneration()">🎨 WebP 애니메이션 생성</button>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill">0%</div>
    </div>

    <div id="message"></div>
    
    <div class="result-box" id="resultBox">
      <h4>✅ 생성 완료!</h4>
      
      <div class="preview-container">
        <h5 style="color: #ffd700;">📋 HTML 코드 (복사해서 사용하세요)</h5>
        <textarea id="previewHtmlCode" readonly style="width:100%; height:150px; background:#1a1a1a; color:#0f0; border:2px solid #00ffd5; border-radius:8px; padding:15px; font-family:monospace; font-size:13px; margin-bottom:15px; resize:vertical;"></textarea>
        <button class="copy-btn" onclick="copyHtmlCode()">📋 HTML 코드 복사</button>
        
        <hr style="border:1px solid #333; margin:25px 0;">
        
        <h5 style="color: #ffd700;">🎬 WebP 애니메이션 미리보기</h5>
        <img id="webpPreview" src="" alt="WebP 미리보기" />
        <br>
        <p style="color: #aaa; font-size: 14px;">💫 마크가 색변화해야 진짜 더블랙샵 입니다!</p>
        <button class="copy-btn" onclick="🔗 URL 복사</button>
        <button class="copy-btn" onclick="downloadImage()">💾 다운로드</button>
      </div>
    </div>

    <div id="debugLog"></div>
  </div>

  <div id="hiddenRender"></div>

  <script>
    const API_URL = '/api/create-webp';
    
    const supabaseUrl = "https://ssnmitgehgzzcpmqwhzt.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzbm1pdGdlaGd6emNwbXF3aHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNjI1MDgsImV4cCI6MjA2ODkzODUwOH0.u3FrSDh5qYeccQmn0PkOs4nfqIhXLSFHhpWj2JXhTrA";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    const chatUrl = "https://open.kakao.com/o/gUVp9cwh";
    let webpUrl = "";

    function log(message) {
      const debugLog = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
      debugLog.scrollTop = debugLog.scrollHeight;
      debugLog.classList.add('show');
      console.log(`[MAIN] ${message}`);
    }

    function showMessage(text, type = 'info') {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = 'show ' + type;
    }

    function updateProgress(percent, text) {
      const fill = document.getElementById('progressFill');
      fill.style.width = percent + '%';
      fill.textContent = percent + '% - ' + text;
      document.getElementById('progressBar').classList.add('show');
    }

    // ============================================
    // 💧 워터마크 HTML 생성 함수 (자동)
    // ⚠️ 이 함수는 수정하지 마세요!
    // ============================================
    function getWatermarkHTML() {
      return `
        <!-- 4개 모서리 배지 -->
        <div class="corner-badge top-left">✓<br>공식</div>
        <div class="corner-badge top-right">✓<br>인증</div>
        <div class="corner-badge bottom-left">✓<br>정품</div>
        <div class="corner-badge bottom-right">✓<br>공식</div>
        
        <!-- 가격표 내부 대각선 워터마크 3개 -->
        <div class="content-watermark wm-diagonal-1">https://open.kakao.com/o/gUVp9cwh ✓</div>
        <div class="content-watermark wm-diagonal-2">https://open.kakao.com/o/gUVp9cwh ✓</div>
        <div class="content-watermark wm-diagonal-3">https://open.kakao.com/o/gUVp9cwh ✓</div>
        <div class="content-watermark wm-diagonal-4">https://open.kakao.com/o/gUVp9cwh ✓</div>
<div class="content-watermark wm-diagonal-5">https://open.kakao.com/o/gUVp9cwh ✓</div>
<div class="content-watermark wm-diagonal-6">https://open.kakao.com/o/gUVp9cwh ✓</div>
<div class="content-watermark wm-diagonal-7">https://open.kakao.com/o/gUVp9cwh ✓</div>
<div class="content-watermark wm-diagonal-8">https://open.kakao.com/o/gUVp9cwh ✓</div>
        
        <!-- 하단 중앙 스티커 -->
        <div class="center-sticker">
          <div class="sticker-title">OFFICIAL</div>
          <div class="sticker-check">✓ ✓ ✓</div>
          <div class="sticker-desc">색변화 = 공식<br>정지 = 짝퉁</div>
        </div>
      `;
    }

    // 오픈채팅 자동 삽입 기능 제거 (해시태그로 대체)
    function insertChatLinks(text, chatUrl) {
      const escapeHTML = (s) => s.replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
      
      // 단순히 HTML 이스케이프만 수행
      return escapeHTML(text);
    }

    // 보호 기능이 포함된 HTML 코드 생성 함수
    function generateProtectedHtml(imageUrl) {
      return `<a href="https://open.kakao.com/o/gUVp9cwh" target="_blank" rel="noopener noreferrer" style="display:block; max-width:100%; margin:0 auto 20px auto; text-decoration:none;">
    <img src="${imageUrl}" 
         alt="오픈카톡 연결" style="cursor:pointer; max-width:100%; height:auto; border-radius:12px; display:block; margin:0 auto; -webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; user-select:none; -webkit-user-drag:none; -khtml-user-drag:none; -moz-user-drag:none; -o-user-drag:none; user-drag:none; pointer-events:none;" draggable="false">

</a>`;
    }

    // HTML 코드 복사 함수
    function copyHtmlCode() {
      const codeTextarea = document.getElementById('previewHtmlCode');
      codeTextarea.select();
      navigator.clipboard.writeText(codeTextarea.value);
      alert('✅ HTML 코드가 복사되었습니다!\n\n게시글에 붙여넣기 하세요.');
    }

    // ============================================
    // 🎨 디자인 HTML 생성 함수 (자유롭게 수정!)
    // ============================================
    function getDesignHTML(priceHtml) {
      return `
        <div class="header-static">
          <div class="auth-warning">
            ⚠️ 진위확인: 8개 마크가 동시에 색변화하면 공식!
          </div>
          <h1 class="shop-logo">
            <span class="icon">🦇</span> THE BLACK SHOP <span class="icon">🧛‍♂️</span>
          </h1>
          <div class="shop-tagline">디아블로4 시즌10 버스 · 대리 · 아이템 전문 거래소</div>
          
          <ul class="shop-features">
            <li><span class="icon">🦾</span> 모든 장비, 아이템, 재료 완비</li>
            <li><span class="icon">🚌</span> 버스, 대리, 세팅 풀 지원</li>
            <li><span class="icon">🦸‍♂️</span> 경험 많은 전문 기사 상시 대기</li>
            <li><span class="icon">🔥</span> 합리적인 실시간 최저가 보장</li>
          </ul>
          
          <div class="cta-btn">
            💬 오픈채팅은 가격표 클릭!
          </div>
        </div>
        
        <hr class="divider">
        
        <div class="price-content">
          <h2 class="price-title">💰 실시간 가격표</h2>
          <div class="price-text">${priceHtml}</div>
        </div>
      `;
    }

    async function startGeneration() {
      const text = document.getElementById('priceText').value.trim();
      if (!text) {
        showMessage('가격표 텍스트를 입력해주세요!', 'error');
        return;
      }

      log('=== WebP 애니메이션 생성 시작 ===');
      document.getElementById('generateBtn').disabled = true;
      document.getElementById('resultBox').classList.remove('show');
      
      try {
        updateProgress(10, 'DB 저장 중...');
        const { error } = await supabase
          .from("user_texts")
          .upsert({ user_id: "theblack04", main_text: text }, { onConflict: "user_id" });

        if (error) throw error;
        log('텍스트 저장 완료');

        updateProgress(20, '4개 프레임 렌더링 중...');
        showMessage('WebP 애니메이션 생성 중... 10~20초 소요됩니다!', 'info');
        
        const frames = await generateAllFrames(text);
        
        updateProgress(70, 'Vercel API로 WebP 생성 중...');
        log('Vercel API 호출');
        
        const webpDataUrl = await createWebPViaAPI(frames);
        
        updateProgress(90, 'Supabase 업로드 중...');
        await uploadWebPToSupabase(webpDataUrl);
        
        updateProgress(100, '완료!');
        showMessage('✅ WebP 애니메이션 생성 완료!', 'success');
        document.getElementById('resultBox').classList.add('show');
        log('=== 작업 완료 ===');

      } catch (err) {
        log('ERROR: ' + err.message);
        showMessage('❌ 오류 발생: ' + err.message, 'error');
      } finally {
        document.getElementById('generateBtn').disabled = false;
      }
    }

    async function generateAllFrames(priceText) {
      const frames = [];
      const priceHtml = insertChatLinks(priceText, chatUrl);
      
      for (let i = 1; i <= 4; i++) {
        log(`프레임 ${i} 렌더링 중...`);
        updateProgress(20 + (i * 10), `프레임 ${i}/4 렌더링 중...`);
        
        // 워터마크 + 디자인 자동 합성
        const frameHtml = `
          <div class="watermark-container price-image frame-${i}">
            ${getWatermarkHTML()}
            ${getDesignHTML(priceHtml)}
          </div>
        `;
        
        const container = document.getElementById('hiddenRender');
        container.innerHTML = frameHtml;
        
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const target = container.querySelector('.watermark-container');
        const canvas = await html2canvas(target, {
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#000000',
          scale: 1,
          logging: false,
          width: 720
        });
        
        frames.push(canvas.toDataURL('image/jpeg', 0.9));
        log(`프레임 ${i} 캡처 완료`);
      }
      
      return frames;
    }

    async function createWebPViaAPI(frames) {
      log('Vercel API 요청 시작');
      
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ frames: frames })
      });

      if (!response.ok) {
        throw new Error(`API 오류: ${response.status} ${response.statusText}`);
      }

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'WebP 생성 실패');
      }

      log(`WebP 생성 완료 (크기: ${(result.size / 1024).toFixed(2)} KB)`);
      return result.webp;
    }

    async function uploadWebPToSupabase(dataUrl) {
      log('Supabase 업로드 시작');
      
      const blob = await (await fetch(dataUrl)).blob();
      await supabase.storage.from("changong-images").remove(['theblack_animated.webp']);

      const { error } = await supabase.storage
        .from("changong-images")
        .upload('theblack_animated.webp', blob, {
          contentType: 'image/webp',
          cacheControl: "3600",
          upsert: true,
        });

      if (error) throw error;

      webpUrl = supabase.storage
        .from("changong-images")
        .getPublicUrl('theblack_animated.webp').data.publicUrl;

      log(`업로드 완료: ${webpUrl}`);
      
      // 미리보기 이미지 표시
      document.getElementById('webpPreview').src = webpUrl + '?t=' + Date.now();
      
      // HTML 코드 생성 및 표시
      const resultCodeValue = generateProtectedHtml(webpUrl);
      document.getElementById("previewHtmlCode").value = resultCodeValue;
      log("HTML 코드 생성 완료");
    }

    function copyUrl() {
      navigator.clipboard.writeText(webpUrl);
      alert('URL이 복사되었습니다!\n' + webpUrl);
    }

    function downloadImage() {
      const a = document.createElement('a');
      a.href = webpUrl;
      a.download = 'theblack_animated.webp';
      a.click();
    }
  </script>
</body>
</html>
