<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë”ë¸”ë™ìƒµ - WebP ì• ë‹ˆë©”ì´ì…˜ ìƒì„±ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Noto Sans KR', Arial, sans-serif;
      background-color: #121212;
      color: #fff;
      padding: 40px 20px;
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #1e1e1e;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
    h2 {
      color: #ffd700;
      text-align: center;
      margin-bottom: 30px;
    }
    .section {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .section h3 {
      color: #00ffd5;
      margin-top: 0;
    }
    .config-note {
      background: #333;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #ffd700;
    }
    textarea {
      width: 100%;
      height: 200px;
      padding: 16px;
      font-size: 16px;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 6px;
      resize: vertical;
      line-height: 1.6;
      font-family: 'Noto Sans KR', monospace;
    }
    button {
      margin-top: 15px;
      background-color: #ffd700;
      color: #000;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s;
      width: 100%;
    }
    button:hover:not(:disabled) {
      background-color: #ffed4e;
      transform: scale(1.02);
    }
    button:disabled {
      background-color: #666;
      cursor: not-allowed;
      transform: scale(1);
    }
    #message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      font-size: 15px;
      display: none;
    }
    #message.show { display: block; }
    #message.info {
      background: #1e3a5f;
      color: #5dade2;
    }
    #message.success {
      background: #1e4d2b;
      color: #52c41a;
    }
    #message.error {
      background: #4d1e1e;
      color: #ff6b6b;
    }
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #333;
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
      display: none;
    }
    .progress-bar.show { display: block; }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ffd5, #ffd700);
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-weight: bold;
      font-size: 14px;
    }
    .result-box {
      background: #232323;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #00ffd5;
      margin-top: 30px;
      display: none;
    }
    .result-box.show { display: block; }
    .result-box h4 {
      color: #ffd700;
      margin-top: 0;
    }
    .preview-container {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }
    .preview-container img {
      max-width: 100%;
      border-radius: 8px;
      margin: 10px 0;
    }
    .copy-btn {
      background: #00ffd5;
      color: #000;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
      width: auto;
    }
    .copy-btn:hover {
      background: #00e6c3;
    }
    #debugLog {
      background: #0a0a0a;
      color: #0f0;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
      display: none;
    }
    #debugLog.show { display: block; }
    #hiddenRender {
      position: fixed;
      left: -10000px;
      top: 0;
    }
    
    /* ë Œë”ë§ ìŠ¤íƒ€ì¼ */
    .combined-render {
      width: 720px;
      background: #000000;
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans KR', Arial, sans-serif;
    }
    .header-section {
      width: 720px;
      height: 400px;
      background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
      color: #ffffff;
      padding: 30px 40px;
      position: relative;
      overflow: hidden;
    }
    .shop-title {
      font-size: 42px;
      font-weight: 900;
      text-align: center;
      margin: 25px 0 15px 0;
      letter-spacing: 3px;
    }
    .frame-1 .shop-title {
      background: linear-gradient(45deg, #ffd700, #ffb347, #ff8c00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .frame-2 .shop-title {
      background: linear-gradient(90deg, #ffb347, #ff8c00, #ff6347);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .frame-3 .shop-title {
      background: linear-gradient(135deg, #ff8c00, #ff6347, #ff4500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .frame-4 .shop-title {
      background: linear-gradient(180deg, #ff6347, #ff4500, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .icon {
      display: inline-block;
      margin: 0 10px;
      font-size: 38px;
    }
    .frame-1 .icon { transform: scale(1.0); }
    .frame-2 .icon { transform: scale(1.05); }
    .frame-3 .icon { transform: scale(1.1); }
    .frame-4 .icon { transform: scale(1.05); }
    .shop-subtitle {
      text-align: center;
      font-size: 19px;
      color: #cccccc;
      margin-bottom: 15px;
      font-weight: 500;
    }
    .subtitle-divider {
      border: none;
      border-top: 1px solid #444444;
      margin: 20px auto;
      width: 85%;
    }
    .info-list {
      list-style: none;
      padding: 0;
      margin: 25px 0;
      text-align: center;
    }
    .info-list li {
      font-size: 17px;
      margin: 12px 0;
      color: #ffffff;
      font-weight: 500;
    }
    .info-list .icon {
      margin-right: 12px;
      font-size: 22px;
    }
    .cta-btn {
      text-align: center;
      font-size: 23px;
      font-weight: 800;
      padding: 18px 45px;
      margin: 25px auto;
      border-radius: 16px;
      border: 2px solid transparent;
      max-width: 450px;
    }
    .frame-1 .cta-btn {
      background: linear-gradient(45deg, #4169e1, #6a5acd, #8a2be2);
      box-shadow: 0 0 20px rgba(65, 105, 225, 0.5);
    }
    .frame-2 .cta-btn {
      background: linear-gradient(90deg, #6a5acd, #8a2be2, #9370db);
      box-shadow: 0 0 22px rgba(106, 90, 205, 0.6);
    }
    .frame-3 .cta-btn {
      background: linear-gradient(135deg, #8a2be2, #9370db, #ba55d3);
      box-shadow: 0 0 25px rgba(138, 43, 226, 0.7);
    }
    .frame-4 .cta-btn {
      background: linear-gradient(180deg, #9370db, #ba55d3, #4169e1);
      box-shadow: 0 0 22px rgba(147, 112, 219, 0.6);
    }
    .frame-1 .info-list li:nth-child(1) .icon { color: #ff6666; transform: scale(1.15); }
    .frame-2 .info-list li:nth-child(2) .icon { color: #66ff66; transform: scale(1.15); }
    .frame-3 .info-list li:nth-child(3) .icon { color: #6666ff; transform: scale(1.15); }
    .frame-4 .info-list li:nth-child(4) .icon { color: #ffff66; transform: scale(1.15); }
    .price-section {
      width: 720px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      padding: 40px 45px;
    }
    .section-price-title {
      font-size: 34px;
      color: #3dffb8;
      font-weight: 900;
      margin-bottom: 25px;
      margin-top: 0;
      letter-spacing: 1.5px;
      text-align: center;
      text-shadow: 0 0 12px rgba(61, 255, 184, 0.5);
    }
    .description {
      font-size: 19px;
      color: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      padding: 25px;
      text-align: center;
      font-weight: 500;
      white-space: pre-wrap;
      margin: 0;
      line-height: 1.8;
      letter-spacing: 0.5px;
    }
    .tb-tagline {
      margin: 8px 0;
      padding: 8px 0;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>ğŸ¦‡ THE BLACK SHOP - WebP ì• ë‹ˆë©”ì´ì…˜ ìƒì„±ê¸°</h2>
    
    <div class="section">
      <h3>ğŸ“ ê°€ê²©í‘œ í…ìŠ¤íŠ¸ ì…ë ¥</h3>
      <div class="config-note">
        ğŸ’¡ <strong>ì£¼ì˜:</strong> Vercel API ì£¼ì†Œë¥¼ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!<br>
        ë°°í¬ í›„ ì•„ë˜ JavaScriptì˜ <code>API_URL</code>ì„ ìˆ˜ì •í•˜ì„¸ìš”.
      </div>
      <textarea id="priceText" placeholder="ì—¬ê¸°ì— ê°€ê²©í‘œ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...

ì˜ˆì‹œ:
âš”ï¸ ì‹œì¦Œ10 ë²„ìŠ¤ ì„œë¹„ìŠ¤
-------------------
ğŸ† ë­í¬ ë²„ìŠ¤
- ê³¨ë“œ â†’ í”Œë˜í‹°ë„˜: 50,000ì›
-------------------
ğŸ¯ ë˜ì „ ëŒ€ë¦¬
- ë‚˜ì´íŠ¸ë©”ì–´: 30,000ì›/ì‹œê°„
"></textarea>
      <button id="generateBtn" onclick="startGeneration()">ğŸ¨ WebP ì• ë‹ˆë©”ì´ì…˜ ìƒì„±</button>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill">0%</div>
    </div>

    <div id="message"></div>
    
    <div class="result-box" id="resultBox">
      <h4>âœ… ìƒì„± ì™„ë£Œ!</h4>
      
      <div class="preview-container">
        <h5 style="color: #ffd700;">ğŸ¬ WebP ì• ë‹ˆë©”ì´ì…˜</h5>
        <img id="webpPreview" src="" alt="WebP ë¯¸ë¦¬ë³´ê¸°" />
        <br>
        <button class="copy-btn" onclick="copyUrl()">URL ë³µì‚¬</button>
        <button class="copy-btn" onclick="downloadImage()">ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>

    <div id="debugLog"></div>
  </div>

  <div id="hiddenRender"></div>

  <script>
    // âš ï¸ ì¤‘ìš”: Vercel ë°°í¬ í›„ ì´ URLì„ ë³€ê²½í•˜ì„¸ìš”!
    const API_URL = '/api/create-webp';  // Vercel ë°°í¬ì‹œ ìë™ìœ¼ë¡œ ì‘ë™
    // ë˜ëŠ” ì „ì²´ URL: 'https://your-project.vercel.app/api/create-webp'
    
    const supabaseUrl = "https://ssnmitgehgzzcpmqwhzt.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzbm1pdGdlaGd6emNwbXF3aHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNjI1MDgsImV4cCI6MjA2ODkzODUwOH0.u3FrSDh5qYeccQmn0PkOs4nfqIhXLSFHhpWj2JXhTrA";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    const chatUrl = "https://open.kakao.com/o/gUVp9cwh";
    let webpUrl = "";

    function log(message) {
      const debugLog = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
      debugLog.scrollTop = debugLog.scrollHeight;
      debugLog.classList.add('show');
      console.log(`[MAIN] ${message}`);
    }

    function showMessage(text, type = 'info') {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = 'show ' + type;
    }

    function updateProgress(percent, text) {
      const fill = document.getElementById('progressFill');
      fill.style.width = percent + '%';
      fill.textContent = percent + '% - ' + text;
      document.getElementById('progressBar').classList.add('show');
    }

    function insertChatLinks(text, chatUrl) {
      const escapeHTML = (s) => s.replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
      
      const palette = ['#00FFD5', '#FFD166', '#FF6B6B', '#7C5CFF', '#7CF17F'];
      const pickColor = (i) => palette[i % palette.length];

      const dividerClass = "[\-\*=~_â”€â”â€”â€“ï¼ï¼¿ã…¡]";
      const splitRe = new RegExp(`(${dividerClass}{3,})`, 'g');
      const tokens = text.split(splitRe);
      const dividerIdxs = [];
      
      for (let i = 1; i < tokens.length; i += 2) dividerIdxs.push(i);

      let chosen = [];
      if (dividerIdxs.length > 0) {
        const candidates = [
          Math.floor(dividerIdxs.length / 4),
          Math.floor(dividerIdxs.length / 2),
          Math.floor(3 * dividerIdxs.length / 4)
        ];
        const seen = new Set();
        chosen = candidates
          .map(ix => dividerIdxs[Math.max(0, Math.min(dividerIdxs.length - 1, ix))])
          .filter(i => Number.isInteger(i) && !seen.has(i) && (seen.add(i), true));
      }

      let extraNeeded = Math.max(0, 3 - chosen.length);
      let tagCount = 0;
      
      const makeTag = () => {
        const color = pickColor(tagCount++);
        return `<div class="tb-tagline" style="font-weight:800;color:${color};">#ë””ì•„ë¸”ë¡œ4 THEBLACK ì˜¤í”ˆì±„íŒ…ë§í¬í™•ì¸ â†’ <span style="text-decoration:underline;">${escapeHTML(chatUrl)}</span></div>`;
      };

      let html = '';
      for (let i = 0; i < tokens.length; i++) {
        if (i % 2 === 0) {
          html += escapeHTML(tokens[i]);
        } else {
          if (chosen.includes(i)) {
            html += `\n${makeTag()}\n`;
          } else {
            html += `\n${escapeHTML(tokens[i])}\n`;
          }
        }
      }

      while (extraNeeded-- > 0) {
        html += `\n-----------------------------------------\n${makeTag()}\n`;
      }

      return html;
    }

    async function startGeneration() {
      const text = document.getElementById('priceText').value.trim();
      if (!text) {
        showMessage('ê°€ê²©í‘œ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
        return;
      }

      log('=== WebP ì• ë‹ˆë©”ì´ì…˜ ìƒì„± ì‹œì‘ ===');
      document.getElementById('generateBtn').disabled = true;
      document.getElementById('resultBox').classList.remove('show');
      
      try {
        updateProgress(10, 'DB ì €ì¥ ì¤‘...');
        const { error } = await supabase
          .from("user_texts")
          .upsert({ user_id: "theblack04", main_text: text }, { onConflict: "user_id" });

        if (error) throw error;
        log('í…ìŠ¤íŠ¸ ì €ì¥ ì™„ë£Œ');

        updateProgress(20, '4ê°œ í”„ë ˆì„ ë Œë”ë§ ì¤‘...');
        showMessage('WebP ì• ë‹ˆë©”ì´ì…˜ ìƒì„± ì¤‘... 10~15ì´ˆ ì†Œìš”ë©ë‹ˆë‹¤!', 'info');
        
        const frames = await generateAllFrames(text);
        
        updateProgress(70, 'Vercel APIë¡œ WebP ìƒì„± ì¤‘...');
        log('Vercel API í˜¸ì¶œ');
        
        const webpDataUrl = await createWebPViaAPI(frames);
        
        updateProgress(90, 'Supabase ì—…ë¡œë“œ ì¤‘...');
        await uploadWebPToSupabase(webpDataUrl);
        
        updateProgress(100, 'ì™„ë£Œ!');
        showMessage('âœ… WebP ì• ë‹ˆë©”ì´ì…˜ ìƒì„± ì™„ë£Œ!', 'success');
        document.getElementById('resultBox').classList.add('show');
        log('=== ì‘ì—… ì™„ë£Œ ===');

      } catch (err) {
        log('ERROR: ' + err.message);
        showMessage('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + err.message, 'error');
      } finally {
        document.getElementById('generateBtn').disabled = false;
      }
    }

    async function generateAllFrames(priceText) {
      const frames = [];
      const priceHtml = insertChatLinks(priceText, chatUrl);
      
      for (let i = 1; i <= 4; i++) {
        log(`í”„ë ˆì„ ${i} ë Œë”ë§ ì¤‘...`);
        updateProgress(20 + (i * 10), `í”„ë ˆì„ ${i}/4 ë Œë”ë§ ì¤‘...`);
        
        const frameHtml = `
          <div class="combined-render frame-${i}">
            <div class="header-section">
              <div>
                <h1 class="shop-title">
                  <span class="icon">ğŸ¦‡</span> THE BLACK SHOP <span class="icon">ğŸ§›â€â™‚ï¸</span>
                </h1>
                <div class="shop-subtitle">ë””ì•„ë¸”ë¡œ4 ì‹œì¦Œ10 ë²„ìŠ¤ Â· ëŒ€ë¦¬ Â· ì•„ì´í…œ ì „ë¬¸ ê±°ë˜ì†Œ</div>
                <hr class="subtitle-divider">
              </div>
              <ul class="info-list">
                <li><span class="icon">ğŸ¦¾</span>ëª¨ë“  ì¥ë¹„, ì•„ì´í…œ, ì¬ë£Œ ì™„ë¹„</li>
                <li><span class="icon">ğŸšŒ</span>ë²„ìŠ¤, ëŒ€ë¦¬, ì„¸íŒ… í’€ ì§€ì›</li>
                <li><span class="icon">ğŸ¦¸â€â™‚ï¸</span>ê²½í—˜ ë§ì€ ì „ë¬¸ ê¸°ì‚¬ ìƒì‹œ ëŒ€ê¸°</li>
                <li><span class="icon">ğŸ”¥</span>í•©ë¦¬ì ì¸ ì‹¤ì‹œê°„ ìµœì €ê°€ ë³´ì¥</li>
              </ul>
              <div class="cta-btn">ğŸ’¬ ì˜¤í”ˆì±„íŒ…ì€ ê°€ê²©í‘œ í´ë¦­!</div>
            </div>
            <div class="price-section">
              <h2 class="section-price-title">ğŸ’° ì‹¤ì‹œê°„ ê°€ê²©í‘œ</h2>
              <div class="description">${priceHtml}</div>
            </div>
          </div>
        `;
        
        const container = document.getElementById('hiddenRender');
        container.innerHTML = frameHtml;
        
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const target = container.querySelector('.combined-render');
        const canvas = await html2canvas(target, {
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#000000',
          scale: 1,
          logging: false,
          width: 720
        });
        
        frames.push(canvas.toDataURL('image/png'));
        log(`í”„ë ˆì„ ${i} ìº¡ì²˜ ì™„ë£Œ`);
      }
      
      return frames;
    }

    async function createWebPViaAPI(frames) {
      log('Vercel API ìš”ì²­ ì‹œì‘');
      
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ frames: frames })
      });

      if (!response.ok) {
        throw new Error(`API ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
      }

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'WebP ìƒì„± ì‹¤íŒ¨');
      }

      log(`WebP ìƒì„± ì™„ë£Œ (í¬ê¸°: ${(result.size / 1024).toFixed(2)} KB)`);
      return result.webp;
    }

    async function uploadWebPToSupabase(dataUrl) {
      log('Supabase ì—…ë¡œë“œ ì‹œì‘');
      
      const blob = await (await fetch(dataUrl)).blob();
      await supabase.storage.from("changong-images").remove(['theblack_animated.webp']);

      const { error } = await supabase.storage
        .from("changong-images")
        .upload('theblack_animated.webp', blob, {
          contentType: 'image/webp',
          cacheControl: "3600",
          upsert: true,
        });

      if (error) throw error;

      webpUrl = supabase.storage
        .from("changong-images")
        .getPublicUrl('theblack_animated.webp').data.publicUrl;

      log(`ì—…ë¡œë“œ ì™„ë£Œ: ${webpUrl}`);
      document.getElementById('webpPreview').src = webpUrl + '?t=' + Date.now();
    }

    function copyUrl() {
      navigator.clipboard.writeText(webpUrl);
      alert('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n' + webpUrl);
    }

    function downloadImage() {
      const a = document.createElement('a');
      a.href = webpUrl;
      a.download = 'theblack_animated.webp';
      a.click();
    }
  </script>
</body>
</html>
